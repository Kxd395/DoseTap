{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://dosetap.com/ssot/constants.json",
  "title": "DoseTap SSOT Constants",
  "description": "Single source of truth for all numeric and enum constants. Generate code and validate docs from this file.",
  "version": "1.0.0",
  "lastUpdated": "2025-01-07",
  
  "doseWindow": {
    "description": "Core dose timing window constraints (non-negotiable medical safety)",
    "minMinutes": {
      "value": 150,
      "description": "Minimum minutes between Dose 1 and Dose 2",
      "configurable": false
    },
    "maxMinutes": {
      "value": 240,
      "description": "Maximum minutes between Dose 1 and Dose 2 (window expires)",
      "configurable": false
    },
    "validTargets": {
      "value": [165, 180, 195, 210, 225],
      "description": "Only valid target interval options (in minutes)",
      "configurable": true,
      "default": 165
    },
    "targetStepMinutes": {
      "value": 15,
      "description": "Increment between valid target options",
      "configurable": false
    },
    "nearWindowThresholdMinutes": {
      "value": 15,
      "description": "Snooze disabled when this many minutes remain",
      "configurable": false
    }
  },
  
  "snooze": {
    "description": "Snooze behavior for Dose 2 reminder",
    "durationMinutes": {
      "value": 10,
      "description": "How long each snooze delays the reminder",
      "configurable": false
    },
    "maxCount": {
      "value": 3,
      "description": "Maximum number of snoozes per session",
      "configurable": true,
      "range": [1, 5],
      "default": 3
    }
  },
  
  "undo": {
    "description": "Undo window for accidental taps",
    "windowSeconds": {
      "value": 5,
      "description": "Seconds after dose/skip action to allow undo",
      "configurable": false
    }
  },
  
  "quickLogPanel": {
    "description": "User-customizable event logging grid",
    "maxSlots": 16,
    "layout": "4x4 grid",
    "customizable": true,
    "defaultSlots": ["bathroom", "water", "lightsOut", "wakeFinal", "wakeTemp", "anxiety", "noise", "pain"],
    "note": "User can choose any events from sleepEvents.types plus custom user-defined events"
  },
  
  "sleepEventEditing": {
    "description": "Sleep events can be edited, deleted, or undone",
    "undoWindowSeconds": 5,
    "undoNote": "5-second undo snackbar appears after logging any event",
    "deleteEnabled": true,
    "deleteNote": "Swipe to delete individual events in timeline, or tap event to edit/delete",
    "editEnabled": true,
    "editableFields": ["timestamp", "notes"],
    "confirmationRequired": {
      "wakeFinal": true,
      "lightsOut": false
    },
    "confirmationNote": "Wake Final shows confirmation dialog before logging because it triggers Morning Check-In flow"
  },
  
  "sleepEvents": {
    "description": "Sleep event types. All are LOCAL-ONLY (SQLite), NOT sent to API.",
    "storage": "local-only",
    "storageNote": "Sleep events are stored in SQLite sleep_events table. The API /events/log endpoint does NOT accept these.",
    "rateLimitingNote": "REVISED: Only physical events (bathroom, water, snack) have cooldowns to prevent accidental double-taps. Mental/environment events have NO cooldown - log as many times as needed.",
    "types": [
      {"rawValue": "bathroom", "cooldownSeconds": 60, "category": "physical", "wireFormat": "bathroom", "rationale": "Prevent accidental double-tap"},
      {"rawValue": "water", "cooldownSeconds": 60, "category": "physical", "wireFormat": "water", "rationale": "Prevent accidental double-tap"},
      {"rawValue": "snack", "cooldownSeconds": 60, "category": "physical", "wireFormat": "snack", "rationale": "Prevent accidental double-tap"},
      {"rawValue": "inBed", "cooldownSeconds": 0, "category": "sleepCycle", "wireFormat": "in_bed", "rationale": "Session marker, no cooldown"},
      {"rawValue": "lightsOut", "cooldownSeconds": 0, "category": "sleepCycle", "wireFormat": "lights_out", "rationale": "Session marker, no cooldown"},
      {"rawValue": "wakeFinal", "cooldownSeconds": 0, "category": "sleepCycle", "wireFormat": "wake_final", "rationale": "Session marker, no cooldown"},
      {"rawValue": "wakeTemp", "cooldownSeconds": 0, "category": "sleepCycle", "wireFormat": "wake_temp", "rationale": "May wake multiple times"},
      {"rawValue": "anxiety", "cooldownSeconds": 0, "category": "mental", "wireFormat": "anxiety", "rationale": "Log as often as experienced"},
      {"rawValue": "dream", "cooldownSeconds": 0, "category": "mental", "wireFormat": "dream", "rationale": "Log as often as experienced"},
      {"rawValue": "heartRacing", "cooldownSeconds": 0, "category": "mental", "wireFormat": "heart_racing", "rationale": "Log as often as experienced"},
      {"rawValue": "noise", "cooldownSeconds": 0, "category": "environment", "wireFormat": "noise", "rationale": "Log as often as experienced"},
      {"rawValue": "temperature", "cooldownSeconds": 0, "category": "environment", "wireFormat": "temperature", "rationale": "Log as often as experienced"},
      {"rawValue": "pain", "cooldownSeconds": 0, "category": "environment", "wireFormat": "pain", "rationale": "Log as often as experienced"}
    ],
    "customEvents": {
      "description": "Users can add custom event types",
      "maxCustomTypes": 8,
      "fields": ["name", "icon", "color"]
    },
    "categories": ["physical", "sleepCycle", "mental", "environment", "custom"],
    "namingConvention": {
      "swift": "camelCase (rawValue field)",
      "sqlite": "snake_case (wireFormat field)",
      "export": "snake_case (wireFormat field)"
    }
  },
  
  "states": {
    "description": "Session state machine phases (literal naming)",
    "phases": [
      {
        "name": "SessionActiveBeforeWindow",
        "description": "Dose 1 taken, waiting for window to open",
        "condition": "dose1TakenAt != nil && minutesSinceDose1 < 150"
      },
      {
        "name": "WindowOpen",
        "description": "Window is open, Dose 2 can be taken",
        "condition": "minutesSinceDose1 >= 150 && minutesSinceDose1 < 225"
      },
      {
        "name": "WindowNearClose",
        "description": "Less than 15 minutes remain, snooze disabled",
        "condition": "minutesSinceDose1 >= 225 && minutesSinceDose1 < 240"
      },
      {
        "name": "WindowExpired",
        "description": "240 minutes passed without Dose 2",
        "condition": "minutesSinceDose1 >= 240 && dose2TakenAt == nil && !dose2Skipped"
      },
      {
        "name": "Dose2Taken",
        "description": "Session complete with Dose 2 taken",
        "condition": "dose2TakenAt != nil"
      },
      {
        "name": "Dose2Skipped",
        "description": "Session complete with Dose 2 skipped",
        "condition": "dose2Skipped == true"
      },
      {
        "name": "NoSession",
        "description": "No active session, ready for Dose 1",
        "condition": "dose1TakenAt == nil"
      }
    ]
  },
  
  "inventory": {
    "description": "Inventory management thresholds",
    "lowThresholdDays": {
      "value": 10,
      "description": "Days remaining to trigger low inventory warning",
      "configurable": true
    },
    "criticalThresholdDays": {
      "value": 3,
      "description": "Days remaining to trigger critical inventory alert",
      "configurable": false
    }
  },
  
  "notifications": {
    "description": "Notification timing and behavior",
    "criticalInventoryRepeatHours": {
      "value": 24,
      "description": "Hours between repeated critical inventory alerts"
    }
  },
  
  "historyView": {
    "description": "History screen display options",
    "sortOptions": [
      {"value": "time_desc", "label": "Newest First", "default": true},
      {"value": "time_asc", "label": "Oldest First"},
      {"value": "name_asc", "label": "A-Z (by event type)"},
      {"value": "name_desc", "label": "Z-A (by event type)"}
    ],
    "filterOptions": {
      "byEventType": true,
      "byDateRange": true,
      "byCategory": true
    },
    "groupBy": ["day", "week", "month", "none"],
    "defaultGroupBy": "day"
  },
  
  "preSleepLog": {
    "description": "Pre-sleep check-in for context logging. Optional, fast, never blocking.",
    "design": {
      "maxCompletionSeconds": 30,
      "cardCount": 3,
      "skippable": true,
      "blocking": false,
      "note": "Never blocks Dose 1 or session start"
    },
    "sessionLinking": {
      "windowMinutes": 120,
      "strategy": "Link to session starting within 2 hours of log creation",
      "unlinkable": true,
      "note": "Logs without linked session are kept as 'Unlinked'"
    },
    "coreQuestions": [
      {
        "id": "intendedSleepTime",
        "card": 1,
        "label": "When do you plan to sleep?",
        "type": "single",
        "options": ["now", "within30", "30to60", "later"]
      },
      {
        "id": "stressLevel",
        "card": 1,
        "label": "Current stress level",
        "type": "scale",
        "range": [1, 5]
      },
      {
        "id": "bodyPain",
        "card": 2,
        "label": "Body pain right now",
        "type": "single",
        "options": ["none", "mild", "moderate", "severe"]
      },
      {
        "id": "stimulants",
        "card": 2,
        "label": "Stimulants after 2pm",
        "type": "single",
        "options": ["none", "caffeine", "nicotine", "both"]
      },
      {
        "id": "alcohol",
        "card": 2,
        "label": "Alcohol today",
        "type": "single",
        "options": ["none", "1to2", "3plus"]
      },
      {
        "id": "exercise",
        "card": 3,
        "label": "Exercise today",
        "type": "single",
        "options": ["none", "light", "moderate", "hard"]
      },
      {
        "id": "napToday",
        "card": 3,
        "label": "Nap today",
        "type": "single",
        "options": ["none", "short", "medium", "long"],
        "optionLabels": {"short": "<30 min", "medium": "30-90 min", "long": "90+ min"}
      }
    ],
    "smartExpanders": {
      "painDetails": {
        "showWhen": "bodyPain != 'none'",
        "questions": [
          {"id": "painLocation", "type": "multi", "options": ["head", "neck", "shoulders", "upperBack", "lowerBack", "hips", "legs", "other"]},
          {"id": "painType", "type": "single", "options": ["aching", "sharp", "throbbing", "burning", "tingling"]}
        ]
      },
      "stressDetails": {
        "showWhen": "stressLevel >= 4",
        "questions": [
          {"id": "stressDriver", "type": "single", "options": ["work", "family", "health", "money", "other"]}
        ]
      },
      "laterDetails": {
        "showWhen": "intendedSleepTime == 'later'",
        "questions": [
          {"id": "laterReason", "type": "single", "options": ["social", "work", "screenTime", "restless", "other"]}
        ]
      }
    },
    "completionStates": ["partial", "complete", "skipped"]
  },
  
  "medicationDefinitions": {
    "description": "First-class medication entries with formulation-specific definitions. Each entry is distinct for tracking and analytics.",
    "xywav": {
      "id": "xywav",
      "displayName": "XYWAV",
      "genericName": "calcium, magnesium, potassium, and sodium oxybates",
      "formulation": "oral_solution",
      "class": "cns_depressant",
      "defaultUnit": "g",
      "dosesPerNight": 2,
      "notes": "Primary medication for DoseTap dose timing"
    },
    "stimulants": [
      {
        "id": "adderall_ir",
        "displayName": "Adderall",
        "genericName": "amphetamine dextroamphetamine",
        "formulation": "ir",
        "class": "stimulant",
        "defaultUnit": "mg",
        "duplicateWarningMinutes": 60,
        "duplicateWarningMessage": "You already logged Adderall recently. Continue only if you truly took another dose."
      },
      {
        "id": "adderall_xr",
        "displayName": "Adderall XR",
        "genericName": "amphetamine dextroamphetamine",
        "formulation": "xr",
        "class": "stimulant",
        "defaultUnit": "mg",
        "duplicateWarningMinutes": 480,
        "duplicateWarningMessage": "You already logged Adderall XR today. XR is typically once-daily. Continue only if prescribed multiple doses."
      },
      {
        "id": "vyvanse",
        "displayName": "Vyvanse",
        "genericName": "lisdexamfetamine",
        "formulation": "xr",
        "class": "stimulant",
        "defaultUnit": "mg",
        "duplicateWarningMinutes": 1440,
        "duplicateWarningMessage": "You already logged Vyvanse today. Continue only if you truly took another dose."
      },
      {
        "id": "ritalin_ir",
        "displayName": "Ritalin",
        "genericName": "methylphenidate",
        "formulation": "ir",
        "class": "stimulant",
        "defaultUnit": "mg",
        "duplicateWarningMinutes": 60
      },
      {
        "id": "ritalin_la",
        "displayName": "Ritalin LA",
        "genericName": "methylphenidate",
        "formulation": "la",
        "class": "stimulant",
        "defaultUnit": "mg",
        "duplicateWarningMinutes": 480
      },
      {
        "id": "concerta",
        "displayName": "Concerta",
        "genericName": "methylphenidate",
        "formulation": "er",
        "class": "stimulant",
        "defaultUnit": "mg",
        "duplicateWarningMinutes": 1440
      },
      {
        "id": "modafinil",
        "displayName": "Provigil",
        "genericName": "modafinil",
        "formulation": "ir",
        "class": "wakefulness_agent",
        "defaultUnit": "mg",
        "duplicateWarningMinutes": 720
      },
      {
        "id": "armodafinil",
        "displayName": "Nuvigil",
        "genericName": "armodafinil",
        "formulation": "ir",
        "class": "wakefulness_agent",
        "defaultUnit": "mg",
        "duplicateWarningMinutes": 720
      }
    ],
    "medicationEventSchema": {
      "description": "Schema for medication_events table and CSV export",
      "fields": [
        {"name": "id", "type": "uuid", "required": true},
        {"name": "session_id", "type": "string", "required": false, "description": "Links to dose session if taken during sleep tracking"},
        {"name": "med_id", "type": "string", "required": true, "description": "References medicationDefinitions.id"},
        {"name": "taken_at_utc", "type": "datetime", "required": true},
        {"name": "local_offset_minutes", "type": "integer", "required": true},
        {"name": "dose_value", "type": "number", "required": true},
        {"name": "dose_unit", "type": "string", "required": true, "default": "mg"},
        {"name": "formulation", "type": "string", "required": true, "enum": ["ir", "xr", "er", "la", "oral_solution"]},
        {"name": "is_duplicate_confirmed", "type": "boolean", "required": false, "default": false, "description": "True if user confirmed after duplicate warning"}
      ],
      "csvExportColumns": [
        "session_id", "taken_at_utc", "local_offset_minutes", "med_id", "display_name", 
        "generic_name", "formulation", "dose_value", "dose_unit", "is_duplicate_confirmed"
      ]
    }
  }
}
